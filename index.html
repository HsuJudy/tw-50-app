<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <title>台灣核心血壓趨勢與風險警示</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: "Microsoft JhengHei", Arial; padding: 20px; background: #f8f9fa; }
    h1 { color: #0066cc; }
    .alert { padding: 15px; background: #ffcccc; border-radius: 8px; font-weight: bold; margin: 15px 0; }
    .info { padding: 15px; background: #e3f2fd; border-radius: 8px; margin: 15px 0; }
    .error { padding: 15px; background: #ffebee; border-radius: 8px; margin: 15px 0; color: #c62828; }
    canvas { max-width: 700px; background: white; border-radius: 8px; padding: 10px; display: block; }
    #chartContainer { margin: 20px 0; }
    #loading { color: #666; font-style: italic; }
  </style>
</head>
<body>
  <h1>台灣核心血壓趨勢與風險警示</h1>
  <div id="holder"></div>
  <div id="loading">載入中...</div>
  <div id="chartContainer">
    <canvas id="bpChart"></canvas>
  </div>
  <div id="alert"></div>
  <div id="error"></div>

  <script>
    // Check if Chart.js loaded
    function checkChartJS() {
      if (typeof Chart === 'undefined') {
        document.getElementById("error").innerHTML = 
          '<div class="error">❌ Chart.js 無法載入。請檢查網路連線或內容安全政策設定。</div>';
        console.error('Chart.js is not loaded');
        return false;
      }
      return true;
    }

    // Initialize chart with data
    function renderChart(dates, sys, dia) {
      const canvas = document.getElementById("bpChart");
      if (!canvas) {
        console.error('Canvas element not found');
        return;
      }

      if (!checkChartJS()) {
        return;
      }

      // Clear any existing chart
      const existingChart = Chart.getChart(canvas);
      if (existingChart) {
        existingChart.destroy();
      }

      // Check if we have data
      if (dates.length === 0 || sys.length === 0 || dia.length === 0) {
        document.getElementById("chartContainer").innerHTML = 
          '<div class="info">目前沒有可用的血壓資料。請確認病患資料中包含生命徵象觀測資料。</div>';
        document.getElementById("loading").style.display = 'none';
        return;
      }

      try {
        new Chart(canvas, {
          type: "line",
          data: {
            labels: dates,
            datasets: [
              { 
                label: "收縮壓 (mmHg)", 
                data: sys, 
                borderColor: "#d32f2f", 
                backgroundColor: "rgba(211, 47, 47, 0.1)",
                tension: 0.3,
                fill: false
              },
              { 
                label: "舒張壓 (mmHg)", 
                data: dia, 
                borderColor: "#1976d2", 
                backgroundColor: "rgba(25, 118, 210, 0.1)",
                tension: 0.3,
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { 
              title: { 
                display: true, 
                text: "血壓趨勢圖 (TW Core Vital Signs Profile)",
                font: { size: 16 }
              },
              legend: {
                display: true,
                position: 'top'
              }
            },
            scales: {
              y: {
                beginAtZero: false,
                title: {
                  display: true,
                  text: '血壓 (mmHg)'
                }
              },
              x: {
                title: {
                  display: true,
                  text: '日期'
                }
              }
            }
          }
        });
        document.getElementById("loading").style.display = 'none';
        console.log('Chart rendered successfully with', dates.length, 'data points');
      } catch (err) {
        console.error('Error rendering chart:', err);
        document.getElementById("error").innerHTML = 
          '<div class="error">❌ 圖表渲染失敗: ' + err.message + '</div>';
        document.getElementById("loading").style.display = 'none';
      }
    }

    // Wait for Chart.js to load
    window.addEventListener('load', function() {
      if (!checkChartJS()) {
        // Try alternative CDN
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js';
        script.onload = function() {
          console.log('Chart.js loaded from alternative CDN');
          checkChartJS();
        };
        script.onerror = function() {
          document.getElementById("error").innerHTML = 
            '<div class="error">❌ 無法從任何 CDN 載入 Chart.js。請檢查網路連線。</div>';
        };
        document.head.appendChild(script);
      }
    });

    // Load patient data and observations
    let patientId = null;
    
    FHIR.oauth2.ready()
      .then(client => {
        console.log('FHIR client ready');
        
        // Try to get patient context first
        const patientContext = client.patient || null;
        if (patientContext && patientContext.id) {
          patientId = patientContext.id;
          console.log('Patient context available:', patientId);
        }
        
        // Load patient data using SMART patient context
        let patientRequest;
        if (client.patient && client.patient.id) {
          // Use SMART patient context to get the current patient
          console.log('Using SMART patient context to load patient');
          patientRequest = client.patient.read();
        } else {
          // Fallback: try to get patient from context or request
          console.log('No patient context, trying direct request');
          patientRequest = client.request("Patient");
        }
        
        return patientRequest.then(patient => {
          console.log('Patient data:', patient);
          
          // Handle both single Patient and Bundle responses
          let patientResource = null;
          if (patient && patient.resourceType === 'Bundle' && patient.entry && patient.entry.length > 0) {
            // Bundle response - get the first patient resource
            patientResource = patient.entry[0]?.resource;
            console.log('Extracted patient from Bundle:', patientResource);
          } else if (patient && patient.resourceType === 'Patient') {
            // Single Patient resource
            patientResource = patient;
            console.log('Received single Patient resource');
          } else {
            console.warn('Unexpected patient response format:', patient);
          }
          
          // Extract patient ID from the actual patient resource, not the bundle
          if (!patientId && patientResource) {
            patientId = patientResource.id;
            console.log('Extracted Patient ID from resource:', patientId);
          } else if (!patientId) {
            // Fallback: try to get from bundle structure
            patientId = patient.id || (patient.entry && patient.entry[0]?.resource?.id) || null;
            console.log('Fallback: extracted Patient ID:', patientId);
          }
          
          if (patientResource) {
            const name = patientResource.name?.[0]?.text || patientResource.name?.[0]?.family || "未知";
            document.getElementById("holder").innerHTML = `<p><strong>病人：</strong>${name}</p>`;
            console.log('Patient name:', name);
          } else {
            document.getElementById("holder").innerHTML = `<p><strong>病人：</strong>未知</p>`;
          }
          
          return { client, patientId };
        });
      })
      .then(({ client, patientId }) => {
        console.log('Requesting observations...');
        console.log('Available patient info:', {
          clientPatientId: client.patient?.id,
          extractedPatientId: patientId,
          clientPatient: client.patient
        });
        
        // Build observation request - try patient context first, fallback to direct request
        let observationRequest;
        let queryPatientId = null;
        
        if (client.patient && client.patient.id) {
          // Use patient context if available - this is the preferred method
          queryPatientId = client.patient.id;
          console.log('Using patient context for observations, Patient ID:', queryPatientId);
          observationRequest = client.patient.request("Observation?category=vital-signs&code=55284-4,85354-9");
        } else if (patientId) {
          // Fallback: use direct request with patient ID
          queryPatientId = patientId;
          console.log('Using direct request with patient ID:', queryPatientId);
          observationRequest = client.request(`Observation?patient=Patient/${patientId}&category=vital-signs&code=55284-4,85354-9`);
        } else {
          // Last resort: try without patient filter (may not work depending on server)
          console.warn('Warning: No patient context or ID available, trying without patient filter');
          observationRequest = client.request("Observation?category=vital-signs&code=55284-4,85354-9");
        }
        
        console.log('Querying observations for Patient ID:', queryPatientId || 'none (no filter)');
        return observationRequest;
      })
      .then(bundle => {
        console.log('Observation bundle received:', bundle);
        
        // Handle both Bundle and array responses
        let entries = [];
        if (bundle && bundle.resourceType === 'Bundle') {
          // Bundle might have entry as array, null, or undefined
          if (Array.isArray(bundle.entry)) {
            entries = bundle.entry;
            console.log(`Found Bundle with ${entries.length} entries (total: ${bundle.total || 'unknown'})`);
          } else if (bundle.entry === null || bundle.entry === undefined) {
            entries = [];
            console.log(`Found Bundle with no entries (total: ${bundle.total || 0})`);
          } else {
            entries = [bundle.entry]; // Single entry wrapped
            console.log(`Found Bundle with single entry`);
          }
        } else if (Array.isArray(bundle)) {
          entries = bundle.map(obs => ({ resource: obs }));
          console.log(`Found array with ${entries.length} observations`);
        } else if (bundle && bundle.entry) {
          entries = Array.isArray(bundle.entry) ? bundle.entry : [bundle.entry];
          console.log(`Found entries array with ${entries.length} items`);
        } else {
          console.warn('Unexpected bundle format:', bundle);
          console.warn('Bundle keys:', bundle ? Object.keys(bundle) : 'bundle is null/undefined');
          entries = [];
        }
        
        const dates = [];
        const sys = [], dia = [];

        entries.forEach((e, index) => {
          try {
            const obs = e.resource || e;
            if (!obs || !obs.resourceType || obs.resourceType !== 'Observation') {
              console.warn(`Entry ${index + 1} is not an Observation:`, e);
              return;
            }
            
            console.log(`Processing observation ${index + 1}:`, {
              id: obs.id,
              code: obs.code?.coding?.[0]?.code,
              hasComponents: !!obs.component,
              componentCount: obs.component?.length,
              hasDate: !!obs.effectiveDateTime
            });
            
            // Check if this is a blood pressure observation
            const code = obs.code?.coding?.[0]?.code;
            if (code === "55284-4" || code === "85354-9") {
              const date = obs.effectiveDateTime ? obs.effectiveDateTime.split("T")[0] : null;
              
              // Find systolic component
              const systolicComp = obs.component?.find(c => {
                const compCode = c.code?.coding?.[0]?.code;
                return compCode === "8480-6";
              });
              const s = systolicComp?.valueQuantity?.value;
              
              // Find diastolic component
              const diastolicComp = obs.component?.find(c => {
                const compCode = c.code?.coding?.[0]?.code;
                return compCode === "8462-4";
              });
              const d = diastolicComp?.valueQuantity?.value;
              
              console.log(`  Date: ${date}, Systolic: ${s}, Diastolic: ${d}`);
              console.log(`  Components:`, obs.component?.map(c => ({
                code: c.code?.coding?.[0]?.code,
                value: c.valueQuantity?.value
              })));
              
              if (s !== undefined && d !== undefined && date) {
                dates.push(date);
                sys.push(Number(s));
                dia.push(Number(d));
                console.log(`  ✓ Added to chart data`);
              } else {
                console.warn(`  ✗ Missing data: date=${date}, sys=${s}, dia=${d}`);
                console.warn(`  Full observation:`, JSON.stringify(obs, null, 2));
              }
            } else {
              console.log(`  Skipped: not a blood pressure observation (code: ${code})`);
            }
          } catch (err) {
            console.error(`Error processing entry ${index + 1}:`, err, e);
          }
        });

        console.log('Processed data summary:', { 
          totalObservations: entries.length,
          bloodPressureObservations: dates.length,
          dates, 
          sys, 
          dia 
        });

        // Show message if no data found
        if (dates.length === 0) {
          console.warn('No blood pressure data found for this patient');
          console.warn('Total entries received:', entries.length);
          console.warn('Sample entry structure:', entries[0]);
          
          // Try fallback: query without code filter
          if (entries.length > 0) {
            console.log('Attempting fallback: filtering all vital signs observations...');
            const allBP = entries.filter(e => {
              const obs = e.resource || e;
              const code = obs.code?.coding?.[0]?.code;
              return code === "55284-4" || code === "85354-9";
            });
            console.log(`Found ${allBP.length} blood pressure observations after filtering`);
          }
          
          document.getElementById("chartContainer").innerHTML = 
            '<div class="info">目前沒有可用的血壓資料。請確認病患資料中包含生命徵象觀測資料。<br>檢查瀏覽器控制台以獲取詳細資訊。</div>';
          document.getElementById("loading").style.display = 'none';
          return;
        }

        // 最新血壓警示 (創新性 + 影響力)
        if (sys.length > 0 && sys[sys.length-1] >= 140) {
          document.getElementById("alert").innerHTML = 
            '<div class="alert">⚠️ 最新收縮壓 ≥ 140 mmHg – 符合台灣高血壓臨床指引，建議立即評估</div>';
        } else {
          document.getElementById("alert").innerHTML = '';
        }

        // Render chart
        renderChart(dates, sys, dia);
      })
      .catch(err => {
        console.error('Error loading patient or observations:', err);
        document.getElementById("holder").innerHTML = `<p><strong>病人：</strong>未知</p>`;
        document.getElementById("error").innerHTML = 
          '<div class="error">❌ 無法載入觀測資料: ' + (err.message || '未知錯誤') + '<br>請確保您已通過 launch.html 啟動應用程式。</div>';
        document.getElementById("loading").style.display = 'none';
      });
  </script>
</body>
</html>