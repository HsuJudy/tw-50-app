<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <title>台灣核心血壓趨勢與風險警示</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: "Microsoft JhengHei", Arial; padding: 20px; background: #f8f9fa; }
    h1 { color: #0066cc; }
    .alert { padding: 15px; background: #ffcccc; border-radius: 8px; font-weight: bold; margin: 15px 0; }
    .info { padding: 15px; background: #e3f2fd; border-radius: 8px; margin: 15px 0; }
    .error { padding: 15px; background: #ffebee; border-radius: 8px; margin: 15px 0; color: #c62828; }
    canvas { max-width: 700px; background: white; border-radius: 8px; padding: 10px; display: block; }
    #chartContainer { margin: 20px 0; }
    #loading { color: #666; font-style: italic; }
  </style>
</head>
<body>
  <h1>台灣核心血壓趨勢與風險警示</h1>
  <div id="holder"></div>
  <div id="loading">載入中...</div>
  <div id="chartContainer">
    <canvas id="bpChart"></canvas>
  </div>
  <div id="alert"></div>
  <div id="error"></div>

  <script>
    // Check if Chart.js loaded
    function checkChartJS() {
      if (typeof Chart === 'undefined') {
        document.getElementById("error").innerHTML = 
          '<div class="error">❌ Chart.js 無法載入。請檢查網路連線或內容安全政策設定。</div>';
        console.error('Chart.js is not loaded');
        return false;
      }
      return true;
    }

    // Initialize chart with data
    function renderChart(dates, sys, dia) {
      const canvas = document.getElementById("bpChart");
      if (!canvas) {
        console.error('Canvas element not found');
        return;
      }

      if (!checkChartJS()) {
        return;
      }

      // Clear any existing chart
      const existingChart = Chart.getChart(canvas);
      if (existingChart) {
        existingChart.destroy();
      }

      // Check if we have data
      if (dates.length === 0 || sys.length === 0 || dia.length === 0) {
        document.getElementById("chartContainer").innerHTML = 
          '<div class="info">目前沒有可用的血壓資料。請確認病患資料中包含生命徵象觀測資料。</div>';
        document.getElementById("loading").style.display = 'none';
        return;
      }

      try {
        new Chart(canvas, {
          type: "line",
          data: {
            labels: dates,
            datasets: [
              { 
                label: "收縮壓 (mmHg)", 
                data: sys, 
                borderColor: "#d32f2f", 
                backgroundColor: "rgba(211, 47, 47, 0.1)",
                tension: 0.3,
                fill: false
              },
              { 
                label: "舒張壓 (mmHg)", 
                data: dia, 
                borderColor: "#1976d2", 
                backgroundColor: "rgba(25, 118, 210, 0.1)",
                tension: 0.3,
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { 
              title: { 
                display: true, 
                text: "血壓趨勢圖 (TW Core Vital Signs Profile)",
                font: { size: 16 }
              },
              legend: {
                display: true,
                position: 'top'
              }
            },
            scales: {
              y: {
                beginAtZero: false,
                title: {
                  display: true,
                  text: '血壓 (mmHg)'
                }
              },
              x: {
                title: {
                  display: true,
                  text: '日期'
                }
              }
            }
          }
        });
        document.getElementById("loading").style.display = 'none';
        console.log('Chart rendered successfully with', dates.length, 'data points');
      } catch (err) {
        console.error('Error rendering chart:', err);
        document.getElementById("error").innerHTML = 
          '<div class="error">❌ 圖表渲染失敗: ' + err.message + '</div>';
        document.getElementById("loading").style.display = 'none';
      }
    }

    // Wait for Chart.js to load
    window.addEventListener('load', function() {
      if (!checkChartJS()) {
        // Try alternative CDN
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js';
        script.onload = function() {
          console.log('Chart.js loaded from alternative CDN');
          checkChartJS();
        };
        script.onerror = function() {
          document.getElementById("error").innerHTML = 
            '<div class="error">❌ 無法從任何 CDN 載入 Chart.js。請檢查網路連線。</div>';
        };
        document.head.appendChild(script);
      }
    });

    // Load patient data
    FHIR.oauth2.ready()
      .then(client => {
        console.log('FHIR client ready');
        return client.request("Patient");
      })
      .then(patient => {
        console.log('Patient data:', patient);
        const name = patient.name?.[0]?.text || patient.name?.[0]?.family || "未知";
        document.getElementById("holder").innerHTML = `<p><strong>病人：</strong>${name}</p>`;
      })
      .catch(err => {
        console.error('Error loading patient:', err);
        document.getElementById("holder").innerHTML = `<p><strong>病人：</strong>未知</p>`;
      });

    // Load observation data
    FHIR.oauth2.ready()
      .then(client => {
        console.log('Requesting observations...');
        return client.patient.request("Observation?category=vital-signs&code=55284-4,85354-9");
      })
      .then(bundle => {
        console.log('Observation bundle received:', bundle);
        const entries = bundle.entry || [];
        const dates = [];
        const sys = [], dia = [];

        entries.forEach(e => {
          const obs = e.resource;
          if (obs.code?.coding?.[0]?.code === "55284-4" || obs.code?.coding?.[0]?.code === "85354-9") {
            const date = obs.effectiveDateTime?.split("T")[0];
            const s = obs.component?.find(c => c.code.coding?.[0]?.code === "8480-6")?.valueQuantity?.value;
            const d = obs.component?.find(c => c.code.coding?.[0]?.code === "8462-4")?.valueQuantity?.value;
            if (s && d && date) {
              dates.push(date);
              sys.push(s);
              dia.push(d);
            }
          }
        });

        console.log('Processed data:', { dates, sys, dia });

        // 最新血壓警示 (創新性 + 影響力)
        if (sys.length > 0 && sys[sys.length-1] >= 140) {
          document.getElementById("alert").innerHTML = 
            '<div class="alert">⚠️ 最新收縮壓 ≥ 140 mmHg – 符合台灣高血壓臨床指引，建議立即評估</div>';
        }

        // Render chart
        renderChart(dates, sys, dia);
      })
      .catch(err => {
        console.error('Error loading observations:', err);
        document.getElementById("holder").innerHTML += "<p>無法取得資料（測試環境正常）</p>";
        document.getElementById("error").innerHTML = 
          '<div class="error">❌ 無法載入觀測資料: ' + (err.message || '未知錯誤') + '</div>';
        document.getElementById("loading").style.display = 'none';
      });
  </script>
</body>
</html>